@model CalendarViewModel

@{
    ViewData["Title"] = Model.IsMyCalendar ? "My Calendar" : "Events Calendar";
    var prevMonth = Model.Month == 1 ? 12 : Model.Month - 1;
    var prevYear = Model.Month == 1 ? Model.Year - 1 : Model.Year;
    var nextMonth = Model.Month == 12 ? 1 : Model.Month + 1;
    var nextYear = Model.Month == 12 ? Model.Year + 1 : Model.Year;
    var daysInMonth = Model.DaysInMonth;
    var firstDayOfMonth = new DateTime(Model.Year, Model.Month, 1).DayOfWeek;
}

<div class="calendar-container">
    <div class="calendar-header mb-4">
        <h1><i class="fas fa-calendar"></i> @(Model.IsMyCalendar ? "My" : "Events") Calendar</h1>
        <p class="text-muted">Browse events in Zimbabwe for @Model.MonthName @Model.Year</p>
    </div>

    <!-- Calendar Navigation -->
    <div class="calendar-nav card mb-4">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <a href="@Url.Action("Index", new { month = prevMonth, year = prevYear })" class="btn btn-outline-secondary">
                    <i class="fas fa-chevron-left"></i> @new DateTime(prevYear, prevMonth, 1).ToString("MMMM yyyy")
                </a>
                <h3 class="mb-0">@Model.MonthName @Model.Year</h3>
                <a href="@Url.Action("Index", new { month = nextMonth, year = nextYear })" class="btn btn-outline-secondary">
                    @new DateTime(nextYear, nextMonth, 1).ToString("MMMM yyyy") <i class="fas fa-chevron-right"></i>
                </a>
            </div>
        </div>
    </div>

    <!-- Calendar Grid -->
    <div class="calendar-grid card">
        <div class="calendar-weekdays">
            <div class="weekday">Sun</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>
        </div>

        <div class="calendar-days">
            <!-- Empty cells for days before month starts -->
            @for (int i = 0; i < (int)firstDayOfMonth; i++)
            {
                <div class="day empty"></div>
            }

            <!-- Days of month -->
            @for (int day = 1; day <= daysInMonth; day++)
            {
                DateTime currentDate = new DateTime(Model.Year, Model.Month, day);
                List<Event> dayEventsList = Model.Events.Where(e => e.StartDate.Date == currentDate.Date).ToList();
                bool isToday = currentDate.Date == DateTime.Today;
                
                <div class="day @(isToday ? "today" : "") @(dayEventsList.Count > 0 ? "has-events" : "")" data-day="@day" data-month="@Model.Month" data-year="@Model.Year">
                    <div class="day-number">@day</div>
                    @if (dayEventsList.Count > 0)
                    {
                        <div class="day-events">
                            @foreach (var item in dayEventsList.Take(2))
                            {
                                <div class="event-badge" title="@item.Title">
                                    <small>@item.Title.Substring(0, Math.Min(10, item.Title.Length))...</small>
                                </div>
                            }
                            @if (dayEventsList.Count > 2)
                            {
                                <small class="text-muted">+@(dayEventsList.Count - 2) more</small>
                            }
                        </div>
                    }
                </div>
            }

            <!-- Empty cells for days after month ends -->
            @{
                var totalCells = (int)firstDayOfMonth + daysInMonth;
                var remainingCells = totalCells % 7 == 0 ? 0 : 7 - (totalCells % 7);
            }
            @for (int i = 0; i < remainingCells; i++)
            {
                <div class="day empty"></div>
            }
        </div>
    </div>

    <!-- Events List -->
    @if (Model.Events.Count > 0)
    {
        <div class="events-section mt-4">
            <h3 class="mb-3">
                <i class="fas fa-list"></i> Events in @Model.MonthName
            </h3>
            <div class="events-list">
                @foreach (var item in Model.Events.OrderBy(e => e.StartDate))
                {
                    <div class="event-card card mb-3">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-1">
                                    <div class="event-date-box text-center">
                                        <div class="date-day">@item.StartDate.Day</div>
                                        <div class="date-month">@item.StartDate.ToString("MMM")</div>
                                    </div>
                                </div>
                                <div class="col-md-7">
                                    <h5>@item.Title</h5>
                                    <p class="text-muted mb-2">
                                        <i class="fas fa-clock"></i> @item.StartDate.ToString("HH:mm") - @item.EndDate.ToString("HH:mm")
                                    </p>
                                    <p class="text-muted mb-0">
                                        <i class="fas fa-map-marker-alt"></i> @item.Location
                                    </p>
                                </div>
                                <div class="col-md-4 text-right">
                                    <p class="mb-2">
                                        <span class="badge badge-primary">@item.Category</span>
                                    </p>
                                    <p class="mb-2">
                                        <small>
                                            <i class="fas fa-users"></i> 
                                            @{var attended = item.Rsvps?.Count(r => r.Status == "Attending") ?? 0;}
                                            @attended/@item.MaxAttendees attending
                                        </small>
                                    </p>
                                    <a href="@Url.Action("Details", "Event", new { id = item.Id })" class="btn btn-sm btn-primary">
                                        View Event
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info mt-4">
            <i class="fas fa-calendar-times"></i> No events scheduled for @Model.MonthName @Model.Year
        </div>
    }

    <!-- Quick Links -->
    <div class="quick-links mt-4">
        <a href="@Url.Action("Index", "Event")" class="btn btn-secondary">
            <i class="fas fa-list"></i> View All Events
        </a>
        @if (!Model.IsMyCalendar)
        {
            var userId = HttpContext.Session.GetInt32("UserId");
            @if (userId != null)
            {
                <a href="@Url.Action("MyCalendar")" class="btn btn-info">
                    <i class="fas fa-calendar-check"></i> View My Calendar
                </a>
            }
        }
    </div>
</div>

<style>
    .calendar-container {
        padding: 20px;
    }

    .calendar-grid {
        border: 1px solid #ddd;
    }

    .calendar-weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #e0e0e0;
        padding: 1px;
    }

    .weekday {
        background-color: #007bff;
        color: white;
        padding: 15px;
        text-align: center;
        font-weight: bold;
    }

    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #e0e0e0;
        padding: 1px;
        min-height: 500px;
    }

    .day {
        background-color: white;
        padding: 10px;
        min-height: 100px;
        position: relative;
        cursor: pointer;
        transition: all 0.3s;
    }

    .day:hover {
        background-color: #f5f5f5;
    }

    .day.today {
        background-color: #fff3cd;
        border: 2px solid #ffc107;
    }

    .day.has-events {
        background-color: #f0f7ff;
    }

    .day.empty {
        background-color: #f9f9f9;
        cursor: default;
    }

    .day-number {
        font-weight: bold;
        margin-bottom: 5px;
    }

    .day-events {
        font-size: 0.75rem;
    }

    .event-badge {
        display: inline-block;
        background-color: #007bff;
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        margin: 2px 0;
        width: 100%;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .event-date-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 8px;
        min-width: 80px;
    }

    .date-day {
        font-size: 1.8rem;
        font-weight: bold;
    }

    .date-month {
        font-size: 0.9rem;
    }

    .event-card {
        border-left: 4px solid #007bff;
    }

    .quick-links {
        display: flex;
        gap: 10px;
    }

    @media (max-width: 768px) {
        .calendar-days {
            min-height: auto;
        }

        .day {
            min-height: 60px;
            padding: 5px;
            font-size: 0.8rem;
        }

        .event-card .col-md-4 {
            margin-top: 10px;
            text-align: left !important;
        }
    }
</style>
